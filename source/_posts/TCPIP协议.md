---
title: TCP/IP协议
date: 2021/07/11
categories:
- linux服务器编程
tags: 
- TCP/IP
- 协议
comments: true
img: '/medias/2.jpg'
sharejs: true
---

  这里是参考《Linux高性能服务器编程》这本书归纳的一些笔记，配图为本书或者网上的图，内容可能不全，梳理下知识点，网络编程面试问的挺多的。

## TCP/IP协议族及主要协议

![RUNOOB 图标](http://djxblogimg.test.upcdn.net/tcpIP/TCPIP.png)

​	TCP/IP协议族是一个四层协议系统，上层的协议使用下层的协议来实现，这幅图应用层的协议不是很全。

### 数据链路层

​	处于物理层之上，屏蔽了不同的电气特性，实现了网卡接口的网络驱动程序。

​	两个主要的协议为ARP（地址解析协议）与RARP协议（逆向地址解析协议）负责MAC地址与ip地址之间的转换

**原因：**

​	网络层使用IP地址寻址机器，而数据链路层使用物理地址来寻址一台机器，网络层需要有目标的IP地址，还需要根据IP地址找到对应的mac地址的机器。ARP将IP地址转化为MAC地址，RARP，在一些难以存储自身IP地址的设备上，MAC地址机器都知道，根据自身的MAC地址向管理者（服务器或管理软件）查询IP地址

#### ARP协议

​	ARP能实现**任意网络地址**到**任意物理地址**的转换，这边仅讨论IP地址到MAC地址转换。

**工作原理：**

​	主机向自己所在的网络广播一个ARP请求，该请求包含目标机器的网络地址。此网络的其他机器都将收到这个请求，但只有一个被请求的目标机器会回应一个ARP应答，其中包含自身的物理地址。

​	广播ARP请求-单播ARP回应。

**请求/应答报文**

![ARP](http://djxblogimg.test.upcdn.net/tcpIP/ARP.png)

- 硬件类型代表物理地址类型，值为1表示MAC地址
- 协议类型代表要映射的协议地址类型，值为0x800，表示IP地址
- 硬件地址长度与协议地址长度，mac地址长度为6，IPV4的地址长度为4
- 操作字段代表4中操作类型：ARP请求（值为1）、ARP应答（值为2）、RARP请求（值为3）和RARP应答（值为4）

**ARP高速缓存**

​	ARP维护一个高速缓存，包含经常访问（比如网关地址）或最近访问的机器的IP地址到物理地址的映射、避免了重复的ARP请求提高收发数据包的速度。

**使用arp -a查看缓存**

![ARP-a](http://djxblogimg.test.upcdn.net/tcpIP/arp-a.png)

### 网络层

​	IP协议（Internet Protocal，因特网协议）是网络层的核心，网络层屏蔽了底层路由器间的转发、不同局域网与广域网间的消息传递，提供端到端的通信。

​	ICMP（Internet Control Message Protocol,因特网控制报文协议），它是IP协议的重要补充，主要用于检测网络连接。

#### IP协议

**IP协议的特点：**

- 无状态
  - IP通信双方不同步传输数据状态信息
  - 所有IP数据报发送、传输、接收都是相互独立的
  - IP数据报头部提供了**标识字段**以标识一个IP数据报，但它是被用来处理IP分片和种族的，不是来指示接收顺序
  - 无状态简单高效，UPD与HTTP协议都是无状态的
- 无连接
  - 通信双发不长久的维持对方信息
  - 每次发送都指明对方IP地址
- 不可靠
  - 只能知道发送失败、但不会尝试重传
  - 需要上层协议的重传机制来保证可靠

**IPv4头部结构**

20字节固定 40字节可选

![IPv4](http://djxblogimg.test.upcdn.net/tcpIP/IPv4.png)

- 4位版本号：
  - 指定IP协议版本 IPv4 值为4
  - 其他IPv4拓展版本（SIP，PIP）有不同的版本号

- 4位头部长度：
  - 标识IP头部有多少32bit字（4个字节）
  - 4位最大值为15 IP头部最大为60

- 8位服务类型
  - 3位优先权字段（现在忽略）
  - 4位TOS字段，分别表示：
    - 最小延时
    - 最大吞吐量
    - 最高可靠性
    - 最小费用
  - 1位保留字段（必须置0）

- 16位总长度
  - 指整个IP数据报的长度，以字节为单位
  - **最大长度65535** 16位

- 16位标识
  - 唯一地标识主机发送的每一个数据报
  - 初始值随机生成
  - 每发一个值就加一

- 3位标志字段
  - 第一位保留
  - 第二位表示禁止分片
  - 第三位表示更多分片 除了最后一个分片，其他分片都要把它置1

- 13位分片偏移
  - 分片相对于原始IP数据报开始处的偏移

- 8位生存时间
  - 数据报到达目的地之前允许经过的路由器跳数
  - 每经过一个路由器，值减一
  - 减为0还没到，像源端发送ICMP差错报文
  - 防止数据陷入路由循环

- 8位协议
  - 用来区分上层协议

- 16位头部校验和
  - 使用CRC算法检验IP数据报头部在传输过程中是否损坏

- 32位源端IP地址
- 32位目的端IP地址

- 可选40字节
  - 记录路由
  - 时间戳
  - 松散源路由选择
  - 严格源路由选择

**IP分片**

  最大传输单元（Maximum Transmission Unit，MTU）用来通知对方所能接受数据服务单元的最大尺寸，说明发送方能够接受的有效载荷大小。

  IP数据报长度超过帧的MTU时，它将被分片传输。

  分片发生在发送端，也可能在中转路由器上

  以太网帧的MTU是1500字节

![MTU](http://djxblogimg.test.upcdn.net/tcpIP/mtu.png)

 所以一个报文携带的数据部分最大为1480字节（20个头部）

![splite](http://djxblogimg.test.upcdn.net/tcpIP/ICMPsplite.png)

​	可见一个1501字节的IP数据报 超过1500，进行分片，第二个无需ICMP头部，仅数据，第一个IP分片设置了MF标志，第二个没有设置这个标志，因为它就是最后一个。

**IPv6头**

​	IPv6头部由40字节的固定头部和可变长的扩展头部组成。

![IPv6](http://djxblogimg.test.upcdn.net/tcpIP/IPv6.png)

- 4位版本号
  - 指定IP协议的版本，IPv6值为6

- 8位通信类型
  - 指示数据流通信类型或优先级，和IPv4中TOS类似

- 20位流标签
  - 用于某些对连接服务质量由特殊要求的通信，比如音频与视频等实时数据传输

- 16位净荷长度
  - 指扩展头部与应用程序数据长度之和，不包含**固定头部长度**

- 8位下一个包头
  - 指紧跟IPv6固定头部后的包头类型，如拓展头或某个上层协议头

- 8位跳数限制
  - 类似IPv4TTL

32位表示IPv地址用点分十进制表示如“127.0.0.1”，而IPv6使用十六进制字符串表示，如“FE80:0000:0000:0000:1134:5678:0000:0012​ ​”

IPv6扩展头部使IPv6支持更多选项

![IPv6](http://djxblogimg.test.upcdn.net/tcpIP/IPv6add.png)

#### ICMP协议

![ICMP](http://djxblogimg.test.upcdn.net/tcpIP/ICMP.png)

ICMP协议主要用于网络连接。

- 8位类型区分报文类型
  - 差错报文，回应网络错误，目标不可达与重定向
  - 查询报文，查询网络信息 Ping就是基于ICMP报文查看目标是否可达

- 8位代码
  - 有些ICMP通过这8位进一步细分不同条件

- 16位校验和
  - 对整个报文（头与内容）进行CRC，检测是否在传输过程中损坏

### 传输层

​	传输层提供端到端的通信。

​	传输层主要协议有三个：TCP协议、UDP协议、SCTP协议。

#### TCP协议

​	TCP协议（传输控制协议）为应用层提供可靠的、面向连接的和基于流的服务。

​	TCP相对于UDP的三大特点：

- 面向连接

  - 使用TCP协议通信的双方先建立连接，然后进行数据的读写，双方为连接分配**必要的内核资源** ，以管理连接的状态和连接上数据的

  传输。TCP连接是**全双工**的，双方的数据读写可以通过**一个**连接进行，完成数据交换后，通信双方断开连接以释放系统资源。

  - TCP协议的连接是**一对一**的，基于广播与多播的应用程序不使用TCP，UDP适合广播与多播。

- 字节流

  - 发送端执行的写操作次数和接收端执行的读操作次数之间没有任何数量关系。

- 可靠传输

  - 三次握手
  - 四次挥手
  - 超时重传
  - 流量控制
  - 拥塞控制
  - 慢启动

##### TCP头部结构           

 	TCP头部结构如下，为**管理TCP连接**和**控制数据流**提供信息

![TCP](http://djxblogimg.test.upcdn.net/tcpIP/TCP.png)

- 16位端口号
  - 源端口
  - 目的端口
  - TCP通信时客户端使用临时端口号
  - 服务器端使用知名端口号
    - DNS:53
    - HTTP:80
    - ftp控制:21
    - ftp数据:20
    - telent:23
    - https:443

- 32位序号
  - 一次TCP通信过程中某个传输方向上的字节流的每个字节的**编号**
  - 如传输的时字节流中1025-2048字节，序号值为：ISN（随机的初始序号值）+1025
  - 

- 32位确认号
  - 对另一方发送来的TCP报文段的响应
  - 值为**收到**的TCP报文段的值加1

- 4位头部长度
  - 标识该TCP头部有多少个32bit字（4字节）。头部最长为60字节

- 6位标志位
  - URG标志：表示紧急指针是否有效
  - ACK标志：表示确认号是否有效
  - PSH标志：提示接收端应用程序应该立即从TCP接收缓冲区中读走数据，为接收后续数据腾出空间
  - RST标志：表示要求对方重新建立连接。（也称复位报文段）
  - SYN标志：表示请求建立一个连接。（也称同步报文）
  - FIN标志：表示通知对方本端要关闭连接（也称结束报文段）

- 16位窗口大小
  - 是TCP流量控制的一种手段
  - 告诉对面本端TCP缓冲区还能容纳多少数据

- 16位校验和
  - 由发送端填充
  - 接收端通过CRC检验传输过程中是否损坏

- 16位紧急指针
  - 是一个正偏移量
  - 它和序号字段的值相加表示最后一个紧急数据的下一字节的序号
  - 是发送端向接收端发送紧急数据的方法

